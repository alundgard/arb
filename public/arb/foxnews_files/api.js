/*! updated; 02-19-2018 09:01 AM */

Modulr.define("FOX_TEMPLATES:controls/api",["require","jquery","lodash","config","FOX_PLUGINS:EventMessageHandler","FOX_PLUGINS:URLInfo"],function(require,$,_,CONFIG){var Events=new(require("FOX_PLUGINS:EventMessageHandler")),URLInfo=require("FOX_PLUGINS:URLInfo"),READY=!1,READY_STACK=[],TEMPLATES={},FRAME_INITIALIZED=!1;Events.addHandler(CONFIG.readyEvent,function(){if(READY=!0,READY_STACK.length>0)for(;READY_STACK.length>0;){var uid=READY_STACK.shift(),info=TEMPLATES[uid];sendMessage(info)}}),Events.addHandler(CONFIG.handlerEvent,function(info){var uid=info.uid;for(TEMPLATES[uid].str=info.str;TEMPLATES[uid].stack.length>0;){var stack=TEMPLATES[uid].stack.shift();stack(info.str)}});var App=function(config){function setPath(template){var url=[basePath,template].join("/").replace(/\/+/i,"/"),dataset=new URLInfo(url),query=dataset.getInfo().query,hasCb=query&&query.cb?!0:!1;if(!hasCb){var cb=function(){var c=new Date,secs=c.getSeconds(),ret=[c.getFullYear(),c.getMonth()+1,c.getDate(),c.getHours(),c.getMinutes()].join("");return ret+=30>=secs?30:1}();dataset.addQuery({cb:cb}),url=dataset.getUrl()}return url}config=config||{};var Proto=this,basePath=config.basePath||"";Proto.get=function(template,callback){FRAME_INITIALIZED||(FRAME_INITIALIZED=!0,embedFrame());var tpl=setPath(template),uid=getTemplateUid(template);TEMPLATES[uid]||(TEMPLATES[uid]={template:tpl,uid:uid,stack:[]}),READY?TEMPLATES[uid].executed?TEMPLATES[uid].str?callback(TEMPLATES[uid].str):TEMPLATES[uid].stack.push(function(str){callback(str)}):(TEMPLATES[uid].executed=!0,TEMPLATES[uid].stack.push(function(str){callback(str)}),sendMessage(TEMPLATES[uid])):(TEMPLATES[uid].stack.push(function(str){callback(str)}),READY_STACK.push(uid))}},sendMessage=function(info){CONFIG.frameId;Events.sendMessage($("#"+CONFIG.frameId).get(0),CONFIG.handlerEvent,{uid:info.uid,template:info.template})},embedFrame=function(){var id=CONFIG.frameId;if(0===$("#"+id).length){var iframe='<iframe id="'+CONFIG.frameId+'" src="'+CONFIG.iframe+'" style="display: none; opacity: 0; width: 0px; height: 0px;" />';$("body").append(iframe)}},getTemplateUid=function(template){var sp=template.split("/"),name=sp[sp.length-1];name=name.split("."),name=name.slice(0,name.length-1).join(".");var uid=[CONFIG.templateEvent,name].join("."),cntr=0;if(uidExists(uid)){for(;uidExists([uid,cntr].join("-"));)cntr++;uid=[uid,cntr].join("-")}return uid},uidExists=function(uid){return TEMPLATES[uid]?!0:!1};return new App});